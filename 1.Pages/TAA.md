---
Type: 
aliases:
  - Temporal Anti-Aliasing
  - 时域抗锯齿
tags: 
modifiedDate: 2025/06/24, 16:43:17
---

# TAA

一种通过之前几帧的结果来对当前帧进行优化的抗锯齿技术。
- 在不同的帧中，同一个像素的颜色样本来自略微不同的子像素位置。TAA 累积这些历史样本，并通过重投影和混合来生成一个平滑的最终图像。

## 工作原理

- 使用某种低差异序列，每帧都对投影矩阵进行微小偏移, 亚像素抖动, 防止 pattern
- 维护前几帧的颜色缓冲
- ⭐ **motion vector 运动向量**[^1]
    - 计算屏幕上每个像素（或每个顶点）相对于上一帧的运动方向和大小。这些**运动向量**用于将上一帧的颜色样本**重投影 (reproject)** 到当前帧的像素位置。
- 混合[^2] 
    - 对于当前帧的每个像素，根据其运动向量，找到其在上一帧历史缓冲中对应的位置，并采样其颜色。
    - 将当前帧的颜色与重投影的历史颜色进行**加权混合**
    - 混合后的结果会再次写入历史缓冲，供下一帧使用。

## 优点

- 高效
- 高质量
- 兼容

## 缺点

- 运动向量计算带来的开销

### 鬼影 (ghosting)

- **现象**：这是 TAA 最常见和最明显的伪影。快速移动的物体或场景中新暴露的区域，可能会在其后方留下半透明的“残影”或“拖尾”。
- **原因**：历史帧的颜色数据未能被完美地重投影或及时地清除。

#### 解决方案

- **限制**历史颜色的**取值范围**, 使其不能超出当前帧周围像素的颜色范围。
    - 计算当前帧一定像素范围（例如 $3\times 3$）内的颜色最大值和最小值，并对历史像素的颜色，在 YCoCg 颜色空间内进行 clamp。
- 速度阈值/衰减
    - 如果一个像素的运动向量表示它正在**快速移动**，那么就减少它来自历史帧的贡献权重（降低 `alpha` 混合因子），或者完全拒绝使用历史数据。
- *使Motion vector 和重投影更精准*
    - 最近深度的
- 使用重投影和motion vector，找到前一帧中的关联像素。

### 闪烁 (Flickering)

- **现象**：图像中高频细节（如远处的细线、栅栏、草地、树叶、细小纹理图案）在摄像机或物体移动时出现不稳定的、跳动的、或消失/出现的伪影。
- **原因**：每帧的采样点有限，对于小于一个像素的细节，采样可能不够稳定；过度激进的鬼影修复方法也可能加剧闪烁。

#### 解决方案

- 更均匀的抖动采样模式 [Halton 序列](Halton%20序列.md), 确保样本在空间和时间上分布均匀，减少重复模式和采样点聚簇。
- 限制历史像素颜色的取值范围, 使其不能超过周围 3x3 像素区域的颜色最大值和最小值, 在 YCoCg[^3] 颜色空间内进行 Clamp

## 优化

### Motion Vector的膨胀

Velocity Buffer的分辨率与屏幕画面一般是一样的，它本身也会存在锯齿。一般会进行膨胀操作，即对于屏幕上的某个像素，会检索周围3x3范围内的9个像素，并找到深度最小 (距离屏幕最近)的那个像素，然后使用这个像素所对应的motion vector进行重投影操作。

#### 案例 : 一个位于快速向右移动角色左侧边缘的背景墙上的像素

- 它自己的运动矢量是 `(0, 0)`。
- 在它的3x3邻域内，有一个属于角色的像素，这个像素的深度值比它小（更近），并且运动矢量是 `(20, 0)`。
- 根据“使用最近像素的运动矢量”的规则，这个背景像素会**抛弃**自己错误的 `(0, 0)` 矢量，转而**采用**角色的 `(20, 0)` 矢量。
- 现在，当TAA为这个背景像素回溯上一帧时，它会向左移动20个像素去采样。它找到的将是**上一帧中它自己真正的前身**（也是背景），而不是错误地采样到角色身上。
    - 如果使用 (0,0), 它会找到上一帧时的角色, 从而导致拖影
- 这样一来，运动物体边缘的拖影和撕裂感就被**极大地减少了**。

### 历史帧信息的修正

*和鬼影和闪烁的解决方法一样*
1. 对于当前帧上的某个像素，会检索周围3x3范围内的9个像素，计算一个颜色的凸包（AABB），然后对历史帧像素的颜色进行clamp（或者使用中心连线的颜色），从而防止历史帧像素的颜色差距过大。
2. 将上述操作在YCoCg空间中进行。

[^1]: 如何生成motion vector：在每一帧中，对几何体进行两次投影变换，一次使用上一帧的投影矩阵，一次使用当前帧的投影矩阵，将两次投影的位移差值（速度velocity）存储在Velocity Buffer中。
[^2]: 一般当前帧像素占比为 10%-20%。
[^3]: YCoCg 空间的优势：分离亮度和色度. 
    - **Y (Luma)**：**亮度**分量。它代表了颜色的明暗程度，基本上就是这个颜色的灰度图。
    - **Co 和 Cg (Chroma)**：**色度**分量。它们代表了颜色与灰色（无彩色）的差异，即“颜色本身是什么”（偏橙还是偏绿）。
