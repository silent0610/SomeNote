---
Type: 
aliases:
  - 屏幕空间反射
  - Screen Space Reflections
tags: 
modifiedDate: 星期三, 六月 4日 2025, 11:17:05 上午
---

## 核心思想

利用当前帧已经渲染好的屏幕空间信息（主要是深度图、法线图和颜色图），通过在屏幕空间进行光线追踪（Raymarching），来查找反射光线可能击中的像素，从而模拟反射。

> 简单来说，就是“反射我所能看到的”。

十分适合手电筒?

## 实现

- **确定反射点 (Reflection Point)**：
    - 对于屏幕上的每个像素 `P`，如果它具有反射属性（例如，金属度或光滑度达到一定阈值），就认为它是一个潜在的反射接收点。
    - 获取像素 `P` 对应的世界空间坐标 (`P_world`)。
- **计算反射向量 (Reflection Vector)**：
    - 获取 `P_world` 处的表面法线 `N`（从法线缓冲）。
    - 获取从 `P_world` 指向摄像机的向量 `V`（观察向量）。
    - 使用反射定律（`R = V - 2 * dot(V, N) * N`）计算反射光线方向 `R`。
    - 将 `R` 转换到视图空间或相机空间（因为后续的深度和法线都在那个空间中）。
- **屏幕空间光线步进 (Screen-Space Raymarching)**：
    - 从 `P_world` 沿着反射向量 `R` 在屏幕空间 [RayMarching](RayMarching.md)
    - 在每一步，计算当前步进点的世界空间坐标 `Ray_world`。
    - 将 `Ray_world` 投影回屏幕空间，得到对应的屏幕坐标 `Ray_screen`。
    - 从深度缓冲中采样 `Ray_screen` 处的深度 `Depth_from_buffer`。
    - 比较 `Ray_world` 的深度与 `Depth_from_buffer`。
        - 如果 `Ray_world` 的深度**与 `Depth_from_buffer` 非常接近**（在一定误差范围内），则认为光线击中了屏幕上的一个物体。
        - 如果 `Ray_world` 的深度**显著大于 `Depth_from_buffer`**，则说明光线穿过了物体，或者错过了。
        - 如果 `Ray_screen` 落在屏幕外，则反射失败。
- **采样颜色和合成 (Sample Color & Composite)**：
    - 如果光线击中了一个物体，则在 `Ray_screen` 处从**颜色缓冲**中采样颜色 `ReflectedColor`。
    - 使用菲涅尔效应 (Fresnel Effect) 和表面的粗糙度/光滑度，计算反射的贡献因子。
    - 将 `ReflectedColor` 与原始像素 `P` 的颜色进行混合/合成，得到最终的反射效果。

## 优缺点

优点:
- **实时性**：相较于光线追踪，SSR 的计算成本更低，适合实时应用（如游戏）。
- **反射动态物体**：可以反射屏幕上所有可见的动态物体和动画。
- **反射屏幕空间效果**：能反射出屏幕上存在的任何效果，包括后期处理效果、粒子系统、体积雾等（只要它们被写入了颜色缓冲）。
- **无需预烘焙**：反射是根据当前帧动态计算的。
- **基于现有数据**：无需额外的几何体渲染通道，利用已有的 G-Buffer 数据。

缺点:
- **屏幕空间限制 (Off-screen Limitation)**：这是 SSR 最主要的局限性。SSR **只能反射屏幕上可见的物体或物体可见的部分**。
- 性能开销: RayMarching 的开销还是不小的, 需要加速算法
- 噪声和锯齿 (Noise & Aliasing)
    - 由于是离散的步进和采样，反射结果可能会出现锯齿或闪烁，尤其是在低采样率或运动中。

## 改进措施

-  [Hi-Z](Hi-Z.md) 加速 [RayMarching](RayMarching.md)
    - 从较高的 Mip 等级开始
    - 如果当前 Raymarching 点的深度**明显比这个 Mip Level 存储的深度更近**，那么就说明在当前 Mip Level 对应的**整个大区域**内，光线都没有击中任何物体。光线就可以安全地**跳过**一大段距离，以一个更大的步长前进，而不用担心错过交点。
    - 只有当光线接近可能发生交点的地方时（即步进点的深度开始接近或超过 Mip Level 存储的深度），才会切换到更低（更高分辨率）的 Mip Level，并减小步长，进行更精细的步进。
