---
Type:
aliases: 
tags: 
modifiedDate: 2025/06/25, 16:38:51
---

# 空间加速结构-相交测试面经

最好直接看 RTR4 22 章

## 有哪些空间加速结构？

常见的空间加速结构有
- [[BVH]] 划分物体
- [[BSP]] 二进制空间划分（binary space partitioning，BSP）划分空间. 包含
    - 轴对齐（axis-aligned）的BSP树 (k-d树).使用一个划分平面，来将空间递归划分为两个子空间
    - 多边形对齐（polygon-aligned）的BSP树。 使用场景中一个多边形所在平面，来将空间递归划分成两个子空间。
- [[八叉树]] 类似于轴对齐的BSP树，会沿着三个轴进行划分，且分割点必须位于单元格的中心，每次划分会产生8个新的包围盒。
- [[场景图]] 除了存储几何对象之外，还包含了纹理、变换、LOD、渲染状态（例如材质属性）和光源等。

## BVH加速结构，对场景中的物体怎么划分的？介绍一下如何构建场景的BVH？

想要创建一个BVH，首先必须能够计算一组物体的紧密BV。常用的自顶向下 BVH的创建过程可以分为以下步骤：
- 为空间中所有物体创建一个完全的包围盒
- 按照一定的划分策略, 将包围盒划分为 2 个或多个子包围盒
    - 顺序 (x, y, z, x...)取某个坐标轴跨度的中点，位于中点左边的BV被分到左子树中，位于中点右边的BV被分到右子树中。
    - 对现有BV进行粗略排序，最左边的一半物体被划分到左子树中，最右边的一半BV被划分到右子树中。
    - 使用表面面积启发式方法（surface area heuristic，SAH）这种方法通过对求交代价和遍历代价进行评估，给出了每一种划分方式的代价（Cost），而我们的目的便是去寻找代价最小的划分。光线击中包围盒的概率可以根据包围体的表面积来估计
- 递归进行, 直到每个包围盒内的图元或物体达到最小阈值, 或者到达深度阈值
![[assets/SAH代价函数解释-1.png]]

## BVH加速结构中，如果光线正好打中两个包围盒的交点，该怎么处理？

光线恰好打到两个包围盒交点，实际上意味着这条光线与两个包围盒都相交，因此需要对其内部的子节点或者几何物体继续进行相交测试。

## 平面中两个三角形求交？

### SAT

> 只要两个凸多边形能被分开，你就总能找到一个“贴着某条边”的分开方式。因此，我们只需要检查那些“贴着边”的轴就足够了。

进行 6 次 SAT 分离轴测试
- 三角形 T1 有 3 条边，对应 3 个法线方向。
- 三角形 T2 有 3 条边，对应 3 个法线方向。
- 因此，我们总共只需要测试 **6 个**潜在的分离轴。
- **只要有任何一个轴**能将两个三角形的投影分开，你就可以**立即停止**并得出结论：**两个三角形不相交**
- 如果你测试完了**所有 6 个轴**，发现它们的投影在**每一个轴上都有重叠**，那么你就可以得出结论：**两个三角形相交**。

### 线段测试

- 遍历 T1 的每一条边，看它是否与 T2 的三条边相交。总共需要进行 `3 * 3 = 9` 次线段相交测试。
- 如果不相交, 可能存在被包含的情况, 进行一个简单的二维三角形重叠测试。即将三角形T_1的每个顶点，针对三角形T_2进行内部测试，例如：对于三角形T_1中的一个顶点$\mathbf{P}$，三角形T_2的顶点为$\mathbf{A},\mathbf{B},\mathbf{C}$，则有：

$$
\mathbf{AP} = u \mathbf{AB} +v\mathbf{AC}
$$

根据上述公式计算出u,v，如果u > 0，v > 0，u + v < 1，则点 $\mathbf{P}$ 位于三角形T_2内部，说明这两个三角形相交。

## 空间中两个三角形求交？

见 RTR4 的 22.11

任务描述：给定两个三角形，$T_{1}=\triangle \mathbf{p}_{1} \mathbf{p}_{2} \mathbf{p}_{3}$ 和 $T_{2}=\Delta \mathbf{q}_{1} \mathbf{q}_{2} \mathbf{q}_{3}$（二者分别位于平面 $\pi_1$ 和 $\pi_2$ 上），我们想确定它们是否相交。
该算法使用了大量的以下操作：

$$
[\mathbf{a}, \mathbf{b}, \mathbf{c}, \mathbf{d}]=-\left|\begin{array}{cccc}a_{x} & b_{x} & c_{x} & d_{x} \\ a_{y} & b_{y} & c_{y} & d_{y} \\ a_{z} & b_{z} & c_{z} & d_{z} \\ 1 & 1 & 1 & 1\end{array}\right|=(\mathbf{d}-\mathbf{a}) \cdot((\mathbf{b}-\mathbf{a}) \times(\mathbf{c}-\mathbf{a}))
$$

1. 判断三角形$T_1$是否与平面$\pi_2$相交：计算 $\left[\mathbf{q}_{1}, \mathbf{q}_{2}, \mathbf{q}_{3}, \mathbf{p}_{1}\right]$ ，$\left[\mathbf{q}_{1}, \mathbf{q}_{2}, \mathbf{q}_{3}, \mathbf{p}_{2}\right]$，$\left[\mathbf{q}_{1}, \mathbf{q}_{2}, \mathbf{q}_{3}, \mathbf{p}_{3}\right]$。如果这些行列式的正负号都相同且不为零，那么则说明 $T_1$ 与平面 $\pi_2$ 不可能有交集，测试到此结束。如果行列式的值全部为零，那么则说明这两个三角形共面，进行平面内三角形的相交测试。
2. 判断三角形$T_2$是否与平面$\pi_1$相交：使用和步骤1中相同的方法。
3. 对三角形顶点进行重新排序，使得第一个顶点单独位于另一个三角形平面的一侧。计算$\left[\mathbf{p}_{1}, \mathbf{p}_{2}, \mathbf{q}_{1}, \mathbf{q}_{2}\right]$，$\left[\mathbf{p}_{1}, \mathbf{p}_{3}, \mathbf{q}_{3}, \mathbf{q}_{1}\right]$ ，若二者都大于0，则说明这两个三角形不相交。

这个测试比 3DSAT 快, 因为可以重用很多计算

## 伪代码：判断点是否位于视锥体内部？

1，假设我们现在已知观察矩阵为$\mathbf{V}$，投影矩阵为$\mathbf{P}$，组合后的复合变换为$\mathbf{M}=\mathbf{P V}$。我们可以从这个复合变换矩阵$\mathbf{M}$中提取出视锥体各个平面的平面方程：

$$
\begin{array}{ll}-\left(\mathbf{m}_{3,}+\mathbf{m}_{0,}\right) \cdot(x, y, z, 1)=0 & {[\text { left }],} \\ -\left(\mathbf{m}_{3,}-\mathbf{m}_{0,}\right) \cdot(x, y, z, 1)=0 & {[\text { right }],} \\ -\left(\mathbf{m}_{3,}+\mathbf{m}_{1,}\right) \cdot(x, y, z, 1)=0 & {[\text { bottom }],} \\ -\left(\mathbf{m}_{3,}-\mathbf{m}_{1,}\right) \cdot(x, y, z, 1)=0 & {[\text { top }],} \\ -\left(\mathbf{m}_{3,}+\mathbf{m}_{2,}\right) \cdot(x, y, z, 1)=0 & {[\text { near }],} \\ -\left(\mathbf{m}_{3,}-\mathbf{m}_{2,}\right) \cdot(x, y, z, 1)=0 & {[\text { far }] .}\end{array}
$$

**计算 点与 6 个平面的距离**
如果6个结果都大于0，则说明该点位于视锥体内部；
若6个结果正负号不同，则说明该点位于视锥体外部；
如果有一个结果为0，说明该点位于视锥体的某个平面上；
如果有两个结果为0，说明该点位于视锥体的某个边上；
如果有两个结果为0，说明该点位于视锥体的某个角点上；

## 伪代码：判断球体是否与视锥体相交？

判断一个包围体（bound volume，BV）是否与视锥体相交，整体思路是将其转换为一个点与体积的相交测试。首先，选择一个相对于BV的点。然后，将这个BV沿着视锥体的外部进行移动，并且尽可能靠近视锥体但不与其重叠。在这个移动过程中，这个相对于BV的点会被追踪，它的轨迹会形成一个新的体积。如果这个相对于BV的点（在其原始位置）位于所描出的体积内部，则说明该BV与视锥体相交。

我们假设视锥体的平面方程的正半空间位于视锥体外部，算法流程如下（该算法是保守近似，在视锥体角落处可能会出现一些误判，将位于视锥体外部的BV认为与视锥体相交）：

1，对于每个视锥体平面，都会计算从球心到该平面的带符号距离（直接将球心带入平面方程即可）。

2，如果这个距离大于半径r，则说明球体位于视锥体外部；如果到所有六个平面的距离都小于- r，则说明球体位于视锥体内部；否则球体与视锥体相交。

3，将上述操作针对6个视锥体平面重复进行。

## 射线与Box求交的过程？

### 方法1：平板法

#渲染器实现细节 
1. 一个三维box可以被视为三个二维slab，每个二维slab与射线相交，可以获得一个最小交点$t^{min}_i$和一个最大交点$t^{max}_i$。
2. 如果$t^{min}_i$ ≤ $t^{max}_i$，说明射线与这个slab相交
3. 如果 $t^{min} \le t^{max}$, 说明相交, 否则不相交

$$
\begin{array} {c} {{{t^{\operatorname* {m i n}}=\operatorname* {m a x} \left( t_{u}^{\operatorname* {m i n}}, t_{v}^{\operatorname* {m i n}}, t_{w}^{\operatorname* {m i n}} \right),}}} \\ {{{t^{\operatorname* {m a x}}=\operatorname* {m i n} \left( t_{u}^{\operatorname* {m a x}}, t_{v}^{\operatorname* {m a x}}, t_{w}^{\operatorname* {m a x}} \right).}}} \\ \end{array}
$$

### 方法2：射线斜率法

1. 将三维box分别投影到三个坐标平面上
2. 找到该坐标平面上的最大角点和最小角点
3. 根据最大角点和最小角点计算最大的可视斜率和最小的可视斜率
4. 判断射线在该平面上的斜率是否在这个范围之内，如果在，则说明相交
5. 分别对三个平面进行测试，如果都满足，则说明射线与box相交

## 射线三角形求交

### **Möller–Trumbore 算法**

将**射线**和**三角形**都用参数方程来表示，然后找到一组参数，使得射线上的点和三角形内的点重合。$P(t)=O+tD$
联立 $P(u,v)=(1−u−v)V0​+uV1​+vV2​$
求解方程

## 射线球体相交

$$
P(t)=O+tD
$$

联立

$$
f(\mathbf{p})=\|\mathbf{p}-\mathbf{c}\|-r=0
\tag{22.5} 
$$

可以优化
- 对于初始点在内部的情况, 可以直接返回相交
- 如果点到中心距离大于半径, 且球在点背后,[^1] 直接拒绝
- 如果射线到中心距离大于半径, 拒绝

## 三角形和包围盒求交

13 次轴测试 [[SAT]]
- **AABB 的三个法线轴**, 对于八叉树包围盒, 即三个坐标系轴. 这可以快速判断两个物体的包围盒是否在某个轴向有分离。
- **三角形的 1 个平面法线**：用来判断AABB是否完全在三角形平面的同一侧
- **9 个由两物体边向量叉乘得到的轴**：
    - 三角形有3条边。
    - AABB有3组互相平行的边（即3个独特的边方向，与坐标轴平行）。
    - 将三角形的每条边分别与AABB的3个边方向进行**叉乘（Cross Product）**，得到 `3 * 3 = 9` 个潜在的分离轴。这是为了处理所有“边-边”靠近的复杂情况。

1. [3 次测试] $\mathbf{e}_0 = (1,0,0)$，$\mathbf{e}_1 = (0,1,0)$，$\mathbf{e}_2 = (0,0,1)$ （AABB 的法线）。换句话说，将这个 AABB 与三角形周围的最小 AABB 进行测试。
2. [1 次测试] $\mathbf{n}$，$\Delta \mathbf{u}_{0} \mathbf{u}_{1} \mathbf{u}_{2}$ 的法线。这里我们使用快速的平面与 AABB 的重叠测试（章节 22.10.1），它只会对 box 对角线上的两个顶点进行测试，其中这个对角线的方向与三角形的法线最为接近。
3.  [9 次测试] $\mathbf{a}_{i j}=\mathbf{e}_{i} \times \mathbf{f}_{j}, i, j \in\{0,1,2\}$，其中 $\mathbf{f}_{0}=\mathbf{v}_{1}-\mathbf{v}_{0}$，$\mathbf{f}_{1}=\mathbf{v}_{2}-\mathbf{v}_{1}$，$\mathbf{f}_{2}=\mathbf{v}_{0}-\mathbf{v}_{2}$，即边向量。这些测试在形式上是相似的，下面我们将只展示 $i = 0$ 和 $j = 0$ 时的推导（详见下文）。

一旦我们找到了一个分离轴，那么算法就会终止并返回“没有重叠”。如果上述所有的测试都通过了，也就是说没有找到分离轴，那么说明这个三角形与 box 会发生重叠。

[^1]: 通过向量投影正负判断
