---
Type:
  - Page
aliases: 
tags: 
modifiedDate: 星期六, 五月 31日 2025, 1:25:27 下午
---

## 定义

是为了配合 `std::shared_ptr` 工作而设计的，它提供了一种**安全的、非拥有式的**方式来观察由 `shared_ptr` 管理的对象。普通指针则不具备这些内建的安全性和与 `shared_ptr` 系统的集成特性。

是一种弱引用，它指向由 [shared\_ptr](shared_ptr.md) 管理的对象，但**不改变对象的强引用计数**, 也就**不阻止资源释放**。

## 实现

- 裸指针成员
- 一个指针指向和 shared ptr 相同的控制块
    - 控制块中记录着有多少 `weak_ptr` 正在观察该资源
    - 控制块只有当 `weak_count` 也降为 0 时才会被释放。
- 析构函数
    - ***不释放资源***
    - **减少控制块中的弱引用计数 (`weak_count`)**：
    - **检查并可能释放控制块**：

## 应用

主要用于解决 `shared_ptr` 的[智能指针循环引用](智能指针循环引用.md)问题。

## 使用

### lock()

- 可以通过 `expired()` 方法检查对象是否已被销毁。
- 更重要的是，不能直接通过 `weak_ptr` 访问对象。你必须调用 `lock()` 方法。`lock()` 会尝试获取一个指向该对象的有效的 `std::shared_ptr`：
    - 如果对象仍然存在，`lock()` 返回一个有效的 `shared_ptr`，你可以安全地通过这个 `shared_ptr` 访问对象（并且在此期间，对象的强引用计数会临时增加）。
    - 如果对象已经被销毁，`lock()` 返回一个空的 `shared_ptr`。
- 这种机制使得 `weak_ptr` 可以安全地处理对象可能已被销毁的情况，避免了悬挂指针的问题。
