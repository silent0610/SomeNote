---
Type: 
aliases:
  - Bounding Volume Hierarchy
  - 层次包围盒
tags: 
modifiedDate: 2025/06/25, 14:42:25
---

# BVH

## 定义

包围体是指包含一组物体的空间体积
- 球体
- 轴对齐包围盒 [[AABB]]
- 定向包围盒
- K-DOP

整个场景以层次化的树状结构进行组织，并由一组相连接的节点组成。每个非叶子节点，都存储了包围内部节点的BV，而叶子节点中则存储了真正的几何物体。
光追或视锥剔除中常用的空间数据结构, 主要用于加速光线追踪中的求交测试

## 构造

通常通过 [Compute Shader](Compute%20Shader.md) 并行构造

### 自顶向下

从包含所有几何体的根节点开始，递归地将当前节点中的图元（Primitives，通常是三角形）分成两组，为每组创建一个子节点。这个过程重复进行，直到每个节点包含的图元数量达到预设的阈值（如 1 到 4 个），成为叶节点。

### 自底向上

从每个单独的图元（作为叶节点）开始。然后迭代地将最靠近或最适合合并的两个节点合并成一个父节点，并计算新的父节点的包围盒。这个过程重复进行，直到所有图元都被包含在一个单一的根节点中。

### 增量树插

方法会从一棵空树开始，然后将所有其他的图元及其BV，逐个添加到这棵树中，如图25.6所示。想要构建一棵高效的树，我们必须在树中找到一个合理的插入点。至于选择这个插入点的指标，应当能够使得树的整体体积的增加量最小。一个简单的方法是将新节点下降到使得树体积增加较小的子节点中。这种算法的运行时间通常为 $O(n \log n)$。将图元的插入顺序进行随机化，可以改善树的构建。

### 线性BVH方法

一种通过对物体按空间顺序排序[^1]后一次性构建 BVH 的高效方法，适用于 GPU 并行构建和实时渲染。
对这个三角形列表进行层次分割，每一步都会创建一个包围其三角形的内部节点。当子列表中没有剩余三角形的时候，或者当子列表中的三角形数量很少的时候（可以打包放入一个叶子节点中），这个过程就会停止。

![[assets/202310191558557.png]]

## 求交 (查询)

当一条光线射入场景进行求交测试时，BVH 会按以下方式加速查询：

1. **从根节点开始**：光线首先与 BVH 的**根节点 AABB** 进行求交测试。
2. **递归遍历**：
    - 如果光线**不与**当前节点的 AABB 相交，那么光线肯定也**不与**该节点包含的任何几何体相交。整个子树都可以被**跳过 (skip)**，无需进一步检查。
    - 如果光线**与**当前节点的 AABB 相交，那么光线可能与该节点包含的几何体相交。此时，光线会递归地进入该节点的**子节点**，并对子节点的 AABB 进行求交测试。
3. **精确求交**：
    - 当光线最终到达**叶节点**时，它会与叶节点中包含的**少量实际几何体**进行精确的求交测试，找到最近的交点。

## 分割

### 中点分割

### 表面积启发式分割

[[SAH]]

[^1]: 根据每个三角形的质心，为其分配一个整数Morton码. 根据它们的Morton码对三角形进行排序
