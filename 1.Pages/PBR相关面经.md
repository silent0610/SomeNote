---
Type: 
aliases: 
tags: 
modifiedDate: 2025/07/09, 21:48:32
---

# PBR相关面经

## 写出渲染方程，并解释其中每项的含义？介绍一下渲染方程？看你做过离线光线追踪的项目，讲讲kajiya渲染方程？（引申）渲染方程中BRDF项的物理含义是什么

[[渲染方程]]

$$
L_{o}(\mathbf{p}, \mathbf{v})=L_{e}(\mathbf{p}, \mathbf{v})+\int_ {\mathbf{l} \in \Omega} f(\mathbf{l}, \mathbf{v}) L_{i}(\mathbf{p}, \mathbf{l})(\mathbf{n} \cdot \mathbf{l})^{+} d \mathbf {l}
$$

- 渲染方程是一个复杂的积分方程式, 它从物理上描述了光线在场景中的传输和相互作用，计算了从表面上某一点沿着某个方向发出的光量。
- 渲染方程整体由两部分组成, 一部分是自发光项, 以及考虑半球方向的入射 radiance, 并计算在观察方向的出射 radiance

1. Lo (p, v), p 点在观察方向 v 的出射 radiance
2. le (p, v) p 点在观察方向 v 的自发光 radiance
3. f (l, v), 双向反射分布函数 [[BRDF]], 描述了该着色点的局部反射系数, 即从方向 l 入射的 radiance 具体有多少会被反射到观察方向 v 上
4. Li (p, l)代表了从某个半球方向 $\mathbf{l}$ 上，入射到表面位置 $\mathbf{p}$ 上的radiance。
5. $(\mathbf{n} \cdot \mathbf{l})^{+}$ 代表了余弦加权，表示 n其中的+代表将 $\mathbf{n} \cdot \mathbf{l}$  clamp到0，即忽略从表面下方的入射radiance。

## 写出 Cook-Torrance BRDF 公式？知不知道cook-torrance？讲述Cook-Torrance BRDF？分别谈一谈 PBR 里面的 D、F、G 项？介绍一下PBR的材质？

-  [[Cook-Torrance BRDF]] 是一个局部着色模型
- 分为漫反射项和镜面反射项
- 其中漫反射项使用 [[Lambertian BRDF]], 即albedo/Pi, 为什么除π见 [[Lambertian BRDF]]
- 镜面反射项是根据微表面理论推导出的

$$
f_{s p e c u l a r}=\frac{D ( h ) \cdot F ( \omega_{i}, h ) \cdot G ( \omega_{i}, \omega_{o}, h )} {4 ( \mathbf{n} \cdot\omega_{i} ) ( \mathbf{n} \cdot\omega_{o} )}
$$

- F 项是菲涅尔近似
- G 是 shadowing-masking 项, 它给出了从光线入射方向和相机观察方向都可见的微面比例，一般使用Smith masking-shadowing。
- D 是法线分布函数 NDF, 常见的有 Beckmann NDF, Blinn-PhongNDF, **GGX NDF**
每项详细见[[微表面理论]]

一般使用 GGX NDF, 搭配 GGX G 项使用, F 项使用 [[Schlick菲涅尔近似]]

## 解释Cook-Torrance模型的能量守恒？

物理定律对任何的BRDF都有两个约束。
- 第一个约束是Helmholtz互易性（Helmholtz reciprocity），这意味着交换入射角和出射角后，其函数值相同；
- 第二个约束是能量守恒——即出射的能量不能大于入射的能量（不考虑自发光）。

对于一个BRDF的能量守恒程度，可以使用定向半球反射率 $R(\mathbf{l})$ 来进行衡量。对于一个给定方向的入射光线，$R(\mathbf{l})$ 测量了该入射光被反射到半球方向内的数量，其本质是测量给定入射方向上的能量损失。其定义如下：

$$
R(\mathbf{l})=\int_{\mathbf{v} \in \Omega} f(\mathbf{l}, \mathbf{v})(\mathbf{n} \cdot \mathbf{v}) d \mathbf{v}
$$

定向半球反射率$R(\mathbf{l})$的值必须始终在$[0,1]$范围内，那么该BRDF就满足能量守恒，可以将Cook-Torrance的BRDF代入计算，来判断它是否满足能量守恒。对于实时渲染来说，我们不要严格保证能量守恒，只需要保证近似的能量守恒即可。

## 解释漫反射项？Lambertian 为什么要除以 $\pi$？

漫反射项模拟了局部次表面散射现象，即部分光线进入物体内部，在经过一定的吸收和散射之后，重新从该表面点（附近）发射出来。漫反射项用于模拟这种局部次表面散射现象。
全局次表面散射有其它的方程进行模拟

[[Lambertian BRDF]] 是最简单的 BRDF，它在半球方向上具有恒定值，即对于一条任意方向的入射光线，其反射光线在半球方向上均匀分布. 

Lambertian 为什么要除以 π精简回答：cos⁡θ在半球范围内的积分为π。
具体见 [[Lambertian BRDF]]

## 解释镜面反射项？漫反射项和镜面反射项的权重取决于什么？

- 光线在经过物质表面时（两种介质的分界面），会发生反射现象，它遵循菲涅尔方程，因此也叫做菲涅尔反射。
- 镜面反射项用于模拟表面反射现象。
[[菲涅尔反射]]
- 菲涅尔效应表明，这种表面-次表面之间的能量权衡应当随入射光角 $\theta _i$  的变化而变化。随着光线入射角度（尤其是靠近掠射角度时）的增大，漫反射反射率会减小，镜面反射率会增大。
- 有很多种考虑这种权衡的方法。实时渲染中一般直接使用金属度来进行控制。即 metallic 越高, 镜面反射比重越大
    - 一般 PBR 材质的 albedo 和 metallic 已经考虑了反射

## F项是什么决定的？解释 $F_0$ 和 $F_{90}$ 的含义、单位、取值范围？

- F 项由[[菲涅尔反射]]决定, 一般使用 [[Schlick菲涅尔近似]]
- 菲涅尔项取决于表面的法线方向与光线的入射方向，以及物质表面本身的特性。
-  $F_0$ 代表当入射光线垂直于表面 $（\mathbf{l}=\mathbf{n}）$ 时的函数值（入射角为0），这个特殊值 $F_0$，可以被认为是物质特有的镜面颜色。当入射角越来越大，菲涅尔函数的值会越来越大，直到入射光线与表面平行（入射角为90），此时菲涅尔函数会输出1（白色），即 $F_{90}$。
- 菲涅尔函数的值会在可见光谱上连续变化，但是出于渲染目的，该函数的输出会被视为RGB向量。取值范围为[0,1]。不同属性的物质，具有不同的 $F_0$ 值。

## D 项是什么？其自变量、值域是多少？能大于 1 吗？

[[法线分布函数|NDF]]
- D项是法线分布函数NDF，它描述了着色点处的微观法线分布，即指向某个方向的微表面数量有多少。NDF的形状（将其绘制在微平面法线的球体上）决定了反射光锥（镜面波瓣）的宽度和形状，反过来又决定了高光的大小和形状。
- [[法线分布函数#GGX|D_GGX]] 使用 N 和 H 的夹角以及 roughness 作为自变量
- NDF的输出是一个标量值，代表了位于该方向的微表面数量（有多少），其范围为 $[0,\infty]$。但是要保证以下两点：[[法线分布函数#特点|NDF约束]]
    - 对 $D(\mathbf{m})(\mathbf{n} \cdot \mathbf{m})$ 进行积分，即将 $D(\mathbf{m})$ 投影到宏表面平面上, 得到的的宏表面面积为 1
    - 微表面（microsurface）和宏表面（macrosurface）在垂直于观察方向 $\mathbf{v}$ 的平面上的投影是相等的

## G 项是什么？

G项描述了两种微观现象：
- 遮蔽（Shadowing）是指部分微尺度表面细节对光源的遮挡，使得光线无法照射到另一部分表面上；
- 遮挡（Masking）是指微尺度表面细节对相机的遮挡，使得一些表面对相机不可见。
如果微观几何的高度与表面法线之间存在相关性，那么Shadowing和Masking可以有效地改变表面的法线分布。

## BRDF 介绍? 解释下什么是BRDF？BRDF基于什么原理？

BRDF 的全称是双向反射分布函数, 它描述了着色点表面的局部反射系数，即从方向 $\mathbf{l}$ 入射的 $radiance$，具体有多少会被反射到观察方向 $\mathbf{v}$ 上。
物理正确的BRDF需要满足以下两个条件：
1. Helmholtz互易性：即交换入射角和出射角后，其函数值相同。
2. 能量守恒：即出射的能量不能大于入射的能量（不包含自发光）。

## 菲涅尔项的F_0有什么含义？

$F_0$ 代表当入射光线垂直于表面 $（\mathbf{l}=\mathbf{n}）$ 时的函数值（入射角为0），这个特殊值 $F_0$，可以被认为是物质特有的镜面颜色。
- 一般材质的 $F_0$ 可以查表得到
- 实践中使用 $F_0 = lerp (F_0, albedo, metallic);$ #渲染器实现细节/PBR 
在 0.04 和 albedo 之间使用 metallic 进行插值得到

## 介绍下PBR的原理？解释下PBR？PBR相比传统渲染有什么区别？

PBR的全称是基于物理的渲染（Physically Based Rendering），它是一类技术的总称，其核心思路是，以一种物理正确的方法，对光线以及光线与表面的相互作用进行量化建模，而不是依赖于经验模型。它主要包含以下内容：
1. 辐射度量学：用于对光线进行量化描述
2. 微表面理论：用于描述物体表面性质
3. 渲染方程与BRDF：用于描述光线与物体表面的相互作用
目前主流使用 [[Cook-Torrance BRDF]]

## PBR的实现需要哪些参数？PBR材质有哪些贴图？PBR需要贴图中包含哪些内容？PBR材质参数？PBR的两种工作流？

BRDF一般包含漫反射和镜面反射两部分组成，一般需要使用
- 法线信息
- 漫反射颜色
- 高光颜色（$F_0$ 值）
- 自发光，
- AO等。
- 这个问题感觉实际上问的PBR工作流，一般有两种工作流，二者各有利弊，没有绝对的优劣之分。

### Metallic/Roughness （金属值/粗糙度）

- base color：物体的漫反射颜色和金属的反射率, 包含RGB三通道。
- Metallic 纹理: 描述表面的金属度，类似于标记哪些表面是金属。
- Roughness贴图：描述表面不规则性（通常Roughness的值会存入base color或Metallic贴图的a通道）。
优点：不需要提供$F_0$值，可以减少错误[^1]；金属度和粗糙度都是单通道的，纹理占用更少；使用更广泛。
缺点：无法使用$F_0​$值；在贴图分辨率较低时，会出现边缘瑕疵。
$F_0 = lerp (F_0, albedo, metallic)$

> 在真实世界中，很少有介于两者之间的“半金属”材质，所以这张贴图通常是接近纯黑或纯白的二值图像（除非是表现生锈金属或污垢覆盖的区域）。

### Specular/Glossiness （镜面反射/光泽度）

漫反射贴图：存储非金属表面的漫反射颜色，包含RGB三通道。
Specular贴图：描述金属表面和非金属表面的$F_0$值，包含RGB三通道。
Glossiness贴图：描述表面的不规则性。它的含义与**粗糙度 (Roughness) 完全相反** (`Glossiness = 1 - Roughness`)。
优点：边缘瑕疵不明显；可以自定义F_0值。
缺点：F_0​值可能用错；有两张RGB贴图，内存占用更大。

## PBR为什么要把diffuse和specular分开？意义是什么？

- 根据微表面理论和菲涅尔效应, 光线在入射到表面上, 整体上有两种现象
    - 表面反射, 部分光线直接被表面反射，遵循菲涅尔方程。对应specular项。
    - 次表面散射, 光线进入物体, 被吸收一部分, 又被散射出来. 不同物质的散射率和吸收率具有显著区别。对应diffuse项。
- 由于这两种现象的发生原因以及外观表现具有显著区别，因此PBR将二者分开处理。

## 什么时候PBR使用次表面散射，什么时候单纯diffuse？

- 这里的问题实质是：什么时候使用全局次表面散射，什么时候使用diffuse来模拟局部次表面散射？（局部和全局的次表面散射技术模拟的是完全相同的物理现象, 但是尺度有所不同）。
- 这里的 diffuse 指局部次表面散射
- 光线在进入物体内部发生次表面散射的时候，会以相对于入射点的不同距离从表面射出，这个进出距离的分布取决于材料中散射粒子的密度和性质。具体是否使用全局次表面散射技术，就取决于这个进出距离和着色尺度之间的关系：
    - 如果进出距离比着色尺度要小，则可以假定它们为零；这样我们就可以将次表面散射与表面反射整合到一个局部着色模型中，即某个着色点上的出射光只依赖于该点的入射光。
    - 如果进出距离比着色尺度大，那么就需要专门的渲染技术来表现光在某一点进入表面并从另一点离开表面的视觉效果，即全局次表面散射技术。

## PBR的导体和绝缘体有什么区别？

物质根据其光学特性可以分为三大类，它们分别是电介质（dielectrics），也就是绝缘体；金属（metals），它们是导体；半导体（semiconductors），它的性质介于电介质和金属之间。
- 金属和电介质有着显著不同的菲涅尔反射值.
    - 电介质具有相当低的F_0值，通常为0.06或者更低，电介质的光学特性在可见光谱上的变化很小 (rgb 值接近)，从而会导致无色的反射值。
    - 金属的 F_0 值相对较高, 一些金属的光学特性会在可见光谱上发生较大变化，从而会产生彩色的反射值。
- 金属和电介质有着显著不同的次表面散射
    - 进入金属的光可以说全部被吸收, 因此金属近乎不会产生次表面散射现象. 对于电介质而言, 光并不会被完全吸收, 存在比较明显的次表面散射. 不同物质的外观表现具有明显不同。

## 微表面模型中如何反应材质的粗糙程度？

- 对于表面反射而言，可以通过改变法线分布来反应材质的粗糙程度，一般会使用一个粗糙度参数，用于控制法线分布的扩散程度。$a = roughness^2$ #渲染器实现细节/PBR 
- 对于次表面散射而言，首先可以使用一个粗糙表面的micro-BRDF ([[Lambertian BRDF]])，还可以额外使用一个用户控制的粗糙度参数，来影响漫反射项。

```hlsl
float3 F0 = float3(0.04, 0.04, 0.04);
F0 = lerp(F0, albedo.rgb, metallic);

float3 F = F_Schlick(dotNV, F0);

float3 kD = (float3 (1.0, 1.0, 1.0) - F) * (1.0 - metallic);
diffuse = kD * albedo / PI
```

注意, 渲染器中 roughness 并没有对次表面散射产生影响 #渲染器实现细节/PBR 

## 菲涅尔项会带来怎样的视觉效果？

由于菲涅尔反射会受到观察角度的影响，且在掠射观察角度下反射率通常会剧烈增加（菲涅尔效应）。因此会产生一些与观察角度有关的视觉现象，例如：
1. 以掠射角度观看物体表面, 会很亮
2. 物体边缘会稍微明亮一些。
3. 远处的水面会变亮。

## PBR 材质贴图很多，纹理槽位不够应该怎么处理？

- 通道打包, 将不同灰度材质属性存储在同一个材质贴图的不同通道中，例如R通道存储粗糙度，G通道存储金属度，B通道存储AO。
- 或者也可以使用 RWBuffer

## PBR 贴图格式需要注意什么？

- 颜色纹理一般存储在sRGB贴图中（在过滤的时候会转换到线性空间中）
    - `VK_FORMAT_R8G8B8A8_SRGB`
    - 采样器硬件会在将颜色值返回给着色器**之前**，自动执行一次**“解码”**操作，即应用 Gamma 曲线的逆运算（近似于 `value^2.2`）。
- 灰度属性（粗糙度，金属度）一般存储在线性空间中。

## 既然roughness可以模拟diffuse效果，为什么还要保留前面的diffuse项？

1. 首先diffuse项和specular项对应的是不同物理现象，将这两项区分开符合PBR原则，物理正确。去掉diffuse项会破坏能量守恒，使得表面看起来更暗。
2. roughness有着自己独特的物理意义，描述了微观法线的扩散程度，会影响BRDF中的N项和G项。如果使用roughness来模拟diffuse项，那就又回到了传统的经验模型，无法推广和统一。
3. 并不适所有diffuse效果都可以使用roughness来进行模拟，只使用roughness来进行模拟的表现能力有限。

## 讲讲实时渲染常用的BRDF？diffuse能不能用lambert以外的函数？

1. Lambertian BRDF（理想漫反射）
2. Blinn-Phong BRDF（Lambertian+高光）[[Blinn-Phong]]
3. [[Cook-Torrance BRDF]]（PBR游戏中很常用）
4. “lunar surface”BRDF（强烈后反射）

diffuse项当然可以使用非Lambertian的，还有很多其他的漫反射BRDF，例如迪斯尼漫反射模型等。

## BRDF 乘以 $\pi$ 的结果是什么

这里的 $\pi$ 是余弦半球积分的结果，这里我们有两种选择，一种是对观察方向 $\mathbf{v}$ 进行积分，结果叫做定向半球反射率

$$
R(\mathbf{l})=\int_{\mathbf{v} \in \Omega} f(\mathbf{l}, \mathbf{v})(\mathbf{n} \cdot \mathbf{v}) d \mathbf{v}
$$

另一种是对光线入射方向$\mathbf{l}$进行积分，结果叫做半球定向反射率

$$
R(\mathbf{v})=\int_{\mathbf{l} \in \Omega} f(\mathbf{l}, \mathbf{v})(\mathbf{n} \cdot \mathbf{l}) d \mathbf{l}
$$

如果这个BRDF满足互易性的话（交换入射方向和出射方向，结果不变），那么半球定向反射率和定向半球反射率实际上是相等的，可以用同一个函数来计算其中任意一个。
在二者可以交换使用的时候，可以用定向反照率（directional albedo）作为两个反射率的统称。

对于Lambertian BRDF而言，这个恒定的反射率通常称为漫反射颜色（diffuse）或者反照率（albedo）, 代表入射光反射出来的所有能量与原能量的比例,

## PBR只有diffuse和specular项吗？

如果表面不会自发光的话，那么只有diffuse和specular两项，分别模拟局部次表面散射现象和表面反射。

如果表面自发光，还可以加入自发光项。如果想要模拟全局次表面散射, 可以使用

## 介绍一下微表面模型理论

[[微表面理论]]
微平面理论假设宏观平整的表面实际上由无数个微小的、方向各异的**微小镜面**组成，每个微平面都进行***镜面反射***。
- 使用法线分布函数 NDF ,D 项,以一种统计方法来描述微表面法线的分布。
- 使用$G_{2}$函数来描述遮蔽（shadowing）和遮挡（masking）现象。
- 使用 F 项表示菲涅尔反射

## 还会问金属度影响的是那部分？

- 金属度是一个标量值，是将镜面颜色 $F_0$ 和漫反射颜色（diffuse color）$\rho_{ss}$ 整合在一起的一种方法。这种方法基于了这样一种观察：金属没有漫反射颜色，而电介质可能的 $F_0$ 值是一个有限集合。如果金属度为1，说明该处是金属，则在base color中记录 $F_0$；如果金属度为0，说明该处是非金属，则在base color中记录漫反射颜色。
- 其动机包括方便用户使用，节省纹理或者G-buffer存储空间等；其缺点在于无法表示某些特殊类型的材料，例如一个具有彩色F_0值的非金属。
- 金属度会影响漫反射部分，和菲涅尔项, 高光项。

```hlsl
float3 F0 = float3(0.04, 0.04, 0.04);
F0 = lerp(F0, albedo.rgb, metallic);

float3 F = F_Schlick(dotNV, F0);

float3 kD = (float3 (1.0, 1.0, 1.0) - F) * (1.0 - metallic);
diffuse = kD * albedo / PI
```

## Tone Mapping、PBR中用到的作用？

[[色调映射]]
Tone Mapping，也叫做色调再现（tone reproduction），是指将场景的radiance转换为显示器radiance的过程，例如将HDR的画面内容显式在一个LDR的显示器上，就需要使用Tone Mapping。
HDR 值域大于 1, 但是显示器一般 LDR, 值域 0-1, 需要使用 Tone Mapping 将 HDR 映射到 LDR

## 介绍一下IBL及其具体实现？

对于镜面反射部分，理想镜面反射很容易实现，难点在于处理glossy材质（即粗糙度），具体有以下方法：
- 镜面反射部分
    1. 可以对环境贴图进行模糊处理，从而模拟粗糙的镜面反射。
    2. 考虑BRDF函数在球面上的形状，然后我们再使用这个分布来对环境贴图进行过滤。可以使用分裂求和（split-sum），对两项进行分别积分。
- 对于漫反射部分，可以从原始环境贴图中生成irradiance环境贴图，并使用表面法线进行索引。

## 是否了解过IBL的预计算推导，分割求和近似的前提是？

[[IBL]]
分割求和近似的形式如下：

$$
\int_{\mathbf{l} \in \Omega} f_{\mathrm{smf}}(\mathbf{l}, \mathbf{v}) L_{i}(\mathbf{l})(\mathbf{n} \cdot \mathbf{l}) d \mathbf{l} \approx \int_{\mathbf{l} \in \Omega} D(\mathbf{r}) L_{i}(\mathbf{l})(\mathbf{n} \cdot \mathbf{l}) d \mathbf{l} \int_{\mathbf{l} \in \Omega} f_{\mathrm{smf}}(\mathbf{l}, \mathbf{v})(\mathbf{n} \cdot \mathbf{l}) d \mathbf{l}
$$

分裂求和的前提是所使用的BRDF是径向对称的，且没有被地平线裁剪。使用蒙特卡洛积分，来对这两项分别进行离线预计算。

1. 第一项中包含了 D 项、原始环境贴图、cos项，对其进行预积分，可以获得不同roughness下的预过滤环境贴图
   对入射光照（Li）和 D 项 (**根据 D 生成采样点**) 进行了积分，但没有包含 Fresnel 项 F 和 G
2. 第二项中包含了BRDF项 (G 和 D (**根据 D 生成采样点**))，其中一般会将F_0提取出来 (没对 F 进行积分, 但对它的系数进行了预计算 [[IBL#LUT BRDF 积分图 (BRDF Integration Map )|LUT]])，因此整个BRDF项只和观察方向和法线方向有关，对其进行积分，得到一张BRDF LUT图。使用采样后的结果，对F_0进行缩放和偏移

**不理解看这里[[202506202228|理解]]**

## 要实现一个崭新的白银剑，应该怎么调整金属度和光滑度，有什么准则吗

崭新的白银剑意味着表面上没有生锈污渍灰尘，即纯金属，因此将金属度设置为1；由于是崭新的金属表面，光滑度要尽量高一些（取决于具体的外观表现）。

金属度的准则是：一般来说，如果物体表面没有灰尘，污渍之类的影响（即纯金属表面），那么金属度是非0即1的

## 解释一下辐照度（irradiance）？

irradiance是辐射度量学中的概念，其定义是辐射通量（radiant flux）相对于面积的密度，即单位面积上的辐射通量，其单位是瓦特每平方米 $(W/m^2)$。其物理意义是代表了表面着色点上接收到的，来自各个不同方向的光线能量。

## Irradiance 和 Radiance 的区别？量纲分别是什么？辐照度解释一下？

- radiance和irradiance是辐射度量学种的概念，用于对电磁辐射的量化描述。
- radiance是指辐射通量相对于面积和立体角的密度,其单位是 $W/m^2 sr$. 其物理意义是对单条光线中电磁辐射的度量。radiance是传感器（如眼睛或者相机）所测量的物理量。
- irradiance的定义是辐射通量（radiant flux）相对于面积的密度，即单位面积上的辐射通量，其单位是$（W/m^2$）。其物理意义是代表了表面着色点上接收到的，来自各个不同方向的光线能量。

[^1]: **更直观、易于理解**：艺术家在创作时，判断“是不是金属”比精确设置反射率数值要简单得多。
