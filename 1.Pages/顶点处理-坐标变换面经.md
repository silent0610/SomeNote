---
Type:
aliases: 
tags: 
modifiedDate: 2025/06/20, 14:58:36
---

# 顶点处理-坐标变换面经

- M矩阵是怎么来的？是如何推导的？
    - 模型是根据自身坐标系进行定义的, 这个坐标系或者说空间就被称为模型空间(model Space)
    - 不同的模型在不同的模型空间内定义, 我们需要将所有的模型(顶点和法线)都变换到统一的世界空间中, 从模型空间到世界空间所用的转换就模型变换, 对应的矩阵就叫模型矩阵,简称 M 矩阵
    - 对模型的基础变换操作包括平移,旋转,缩放和剪切四种. 
        - 将各个矩阵按照顺序依次左乘, 即可得到模型矩阵
        - 即 平移 x 旋转 x (缩放, 剪切)
        - 即先缩放剪切, 再旋转, 再平移
    - 先在物体的“局部空间”（Local Space）或“模型空间”（Model Space）中完成对物体自身的修改，然后再将其放置到“世界空间”（World Space）中。
- 给定M矩阵，能否分解为几种变换矩阵？根据M矩阵分解出平移、旋转和缩放？
    - 提取平移矩阵：直接取4 x 4矩阵中最后一列的元素即可。
    - 提取旋转矩阵和缩放矩阵：将平移分量置为0，剩余矩阵就是旋转矩阵和缩放矩阵相乘的结果。
    - 进一步分离旋转矩阵和缩放矩阵，假设此时的矩阵M中不包含平移分量，即
    - $\mathbf{M} = \mathbf{SR}$, $\mathbf{M}^{T} = \mathbf{(SR)}^T = \mathbf{R}^T \mathbf{S}^T$, $\mathbf{M} \mathbf{M}^{T} = \mathbf{SR}\mathbf{R}^T \mathbf{S}^T = \mathbf{S} \mathbf{S}^T$
    - R 矩阵是正交的, 而 S 矩阵是对角矩阵, 只包含对角线元素, 所以可以先获得 S 矩阵, 再求 R
- 变换矩阵中哪些是正交矩阵？
    - 旋转矩阵
- 说一下GPU渲染管线中有哪些坐标空间？他们是如何进行变换的？一个顶点是如何从局部坐标变换到屏幕上的？描述渲染过程空间的变换？
    - 分别有模型空间(model space), 世界空间(world space)观察空间(view space,相机空间), 裁剪空间(clip space), NDC(标准设备坐标系),屏幕空间(screen space)
    - 模型空间的顶点, 经过模型变换, 变换到世界空间. 使用 VIew 矩阵, 从世界空间移到观察空间 (即将相机置于原点, 使其看向-z, 看向+z 也有, 转换比较简单)
        - unity 左手系, x 右, y 上, z 前
        - UE 左手系, x 前, y 右, z 上
    - 使用相应的投影变换, 模型从观察空间中变换到裁剪空间, 并对不在标准立方体内的顶点进行剔除
    - 将NDC中的顶点进行屏幕映射（screen mapping），转换到屏幕空间（screen space）中。
- 各个矩阵的结合顺序怎么确定？
    - 对于模型变换而言，最常用的矩阵组合顺序为 $TRS$,即依次进行缩放、旋转和平移。
    - 对于整个过程的变换而言，矩阵的组合顺序为 $\mathbf{PVM}$，即依次进行模型变换、观察变换和投影变换。
- 视口变换的作用是什么，空间的维度是如何变化的？视口变换时深度值如何处理？
    - 视口变换也叫做屏幕映射（Screen Mapping），它包含一个缩放操作，其目的是将顶点从NDC中变换到屏幕坐标系中，顶点坐标被称为屏幕坐标。空间从三维立方体变成二维平面。
    - 同时深度信息会被映射到 $[z_1, z_2]$ 中。不同的API处理深度的方式不同，OpenGL中的范围是[-1, +1]，在DirectX 和 vulkan 中的范围是[0,1]。（注意反向z缓冲）
- NDC是什么？NDC 空间的范围是多少，所有平台都是这样吗？
    - NDC 全称是规范化设备坐标系, 是一个轴对齐的立方体，在OpenGL中，这个轴对齐立方体的范围是从 [-1,-1,-1]到[1,1,1], vulkan 和 dx 的范围是从[-1,-1,0]到[1,1,1]
    - 在进行投影变换之后，可以将观察空间变换为裁剪空间；在执行透视除法之后，会变换为NDC空间。
    - 转换为 NDC 的原因是：
        1. 转换为与具体输出设备无关的标准化坐标系，使得图形图像在不同分辨率、不同尺寸和不同设备上都能正确显示，并保持一致性。
        2. 方便了图形处理、显示和渲染过程中的各种操作和变换。
- 描述顶点着色器中的坐标变换。
    - 描述顶点着色器中的坐标变换。
- 在各空间中，哪些是左手系，哪些是右手系，为什么会这样的变化？
    - 模型空间：Unity采用左手坐标系，3dsMax采用右手坐标系。
    - 世界空间：Unity采用左手坐标系 , x 右, y 上, z 前,  UE 左手系, x 前, y 右, z 上
    - 观察空间：OpenGL采用右手坐标系（相机看向负z轴），DirectX采用左手坐标系（相机看向正z轴）。
    - 裁剪空间：通常使用左手系。即视口的x轴指向右方，y轴指向上方，z轴指向视口内侧。
        - 但是 vulkan 是右手系, x 向右, y 向下, 原因可能是为了和屏幕空间坐标对齐. 更贴近硬件. 减少抽象
    - 具体使用左手系还是右手系实际上是等价的，二者也可以进行转换，主要取决于习惯和约定。
        - 数学与科学计算的传统 (OpenGL 的右手系, Y轴向上) 我们习惯 y 轴向上, 所以 opengl 就让 y 向上
        - 屏幕, 图像的坐标系原点在左上角. 这是因为 电子束或像素数据是从屏幕/图像的**左上角**开始，逐行向下扫描的。
        - 建筑、CAD、3D打印领域 (Z 轴为“上”) X 和 Y 构成了地平面，那么 Z 轴自然而然地就代表了**高度或海拔**。像 **Blender**, **3ds Max**, **AutoCAD** 等软件，都默认使用 Z 轴作为“向上”的轴。
        - 又比如 UE 的 Z 向上
- V矩阵的功能是什么？如何进行推导？如何根据摄像机信息写出V矩阵？描述V矩阵的计算过程？
    - 只有被相机（或观察者）看到的模型才会被渲染，相机在世界空间中有一个位置和方向，用于放置相机和调整相机朝向。为了便于后续的投影和裁剪操作，相机和世界空间中的所有模型都会应用观察变换（view transform），所使用的矩阵就是观察矩阵，观察变换的主要目的是将相机在原点上，并调整相机朝向，让其看向z轴负半轴的方向，同时y轴指向上，x轴指向右。
    - View 可以分为两步, 首先是一个平移变换, 将相机平移至原点, 然后是一个基地变换, 调整相机的朝向, 为了构建这个基底变换矩阵，我们需要事先计算相机的原始基底 ${r, u, v}$,中 $\mathbf{v}$ 是观察向量，从相机位置指向目标位置的单位向量；$\mathbf{r}$ 是指向右的向量，$\mathbf{u}$ 是 $\mathbf{r}$ 和 $\mathbf{v}$ 的叉乘结果。最终的观察变换矩阵为：
    - 易于理解, 摄像机世界变换的“逆” $V=(T\cdot R)^{-1}$

$$
\begin{aligned} \begin{array}{} \mathbf{M} &= \underbrace{ \left ( \begin{array}{} r_x & r_y & r_z & 0 \\ u_x & u_y & u_z & 0 \\ -v_x & -v_y & -v_z & 0 \\ 0 & 0 & 0 & 1 \\ \end{array} \right) }_{\mathsf{change\ of \ basis}} \underbrace{ \left ( \begin{array}{} 1 & 0 & 0 & -t_x \\ 0 & 1 & 0 & -t_y \\ 0 & 0 & 1 & -t_z \\ 0 & 0 & 0 & 1 \\ \end{array} \right) }_{\mathsf{translation}} \\[4mm] &=\left ( \begin{array}{} r_x & r_y & r_z & -\mathbf{t \cdot r} \\ u_x & u_y & u_z & -\mathbf{t \cdot u} \\ -v_x & -v_y & -v_z & -\mathbf{t \cdot v} \\ 0 & 0 & 0 & 1 \\ \end{array} \right) \end{array} \end{aligned}
$$

- 正交投影和透视投影有什么区别？投影矩阵具体怎么推导？
    - 两者的推导可见 [[MVP 矩阵的推导]]
    - 对于正交投影而言，它的一个特征是，投影之前的平行线，在投影之后仍然会保持平行。这也就意味着，当使用正交投影来观察一个场景的时候，无论场景中的物体距离相机多远，它们的大小都不会发生改变。
    - 正交投影矩阵首先会对代表正交可视空间的AABB进行平移，然后再进行缩放，将其变成一个立方体，根据深度映射的不同范围，相应的变换矩阵也有所不同，这里使用OpenGL中的进行举例（立方体的深度范围为[-1,1]）：
    - 对于透视投影而言，投影变换前的平行线在投影之后通常就不再平行了，相反，这些平行线可能会在它们的尽头汇聚成一个点。透视投影更加符合我们人眼观察这个世界的模式，因为它具有近大远小的特点。
    - 有关透视投影的推导，可以从二维情况出发（相似三角形），再扩展到三维情况。透视投影的整个过程，可以这样理解：首先将视锥体的远裁剪平面按一定规则缩放到和近裁剪平面一样的尺寸，即将视锥体变成一个长方体；然后再按照正交投影的方式将其变换成一个规则观察体。OpenGL中的透视投影矩阵为：
- 在 NDC 空间的点如何变换回世界空间？
    - 点在 NDC 空间中和世界空间中的 w 分量都为 1。将 NDC 坐标 VP 的逆矩阵，然后再将计算得到的坐标除以 w 分量，即可得到世界空间坐标，公式如下：

$$
\mathbf{p}_{world} =\dfrac{ \mathbf{p}_{NDC} \cdot \mathbf{(PV)}^{-1}}{(\mathbf{p}_{NDC} \cdot \mathbf{(PV)}^{-1})_w}
$$

- 透视除法中w是什么意思，值为零或者值为1有什么区别？为什么要除上w？其意义何在？
    - 齐次坐标, 将三维的坐标用四维坐标表示, 为了统一平移矩阵和旋转矩阵的表示
    - w 是齐次 1 坐标的第四个分量. 齐次坐标在除以 w 后, 如果相同, 则是相同点
    - 值为 0 代表向量, 因为向量不受 MVP 变换影响.  值为 1 代表点
    - 在投影变换之前的若干变换，并不会对齐次坐标的w分量产生影响，同时，这些变换矩阵的第四行（最底行）都是(0,0,0,1)。而现在透视投影变换将涉及到对齐次坐标w分量的修改。也就是说，w分量在透视投影变换之后可能并不为0或者1，因此需要将齐次坐标的每个分量都除以w分量，这样才能获得非齐次的点坐标。正交投影变换不会改变w分量。
- 空间变换时法线与顶点不同需要做怎样的处理？
    - 对法线正确的变换方法是：使用原始变换矩阵的伴随矩阵（adjoint）的转置矩阵对其进行变化，而不是使用原始变换矩阵本身进行变换。
- 项目中怎么实现相机的移动效果？
    - 实现相机的移动效果，即对相机进行平移变换和旋转变换。可以使用一个矩阵来完成，其中平移矩阵就是从相机当前位置向目标位置的位移变换。旋转矩阵可以使用欧拉变换获得，或者使用四元数来获得一个旋转矩阵。[[四元数]] [[欧拉角]]
- 矩阵SVD分解？
    - SVD分解全称是奇异值分解，用于PCA、图像压缩、特征压缩等。是一种将**任意一个矩阵**分解为三个具有特殊性质的、更“简单”的矩阵乘积的方法。
    - 矩阵 $\mathbf{A}^{T}\mathbf{A}$ 特征值的算术平方根叫做矩阵 $\mathbf{A}$ 的奇异值。存在矩阵 $\mathbf{U},\mathbf{\Sigma},\mathbf{V}^{T}$，使得 $\mathbf{A}=\mathbf{U}\mathbf{\Sigma}\mathbf{V}^{T}$。（具体各个矩阵代表什么，去网上找一下就行，这里写起来很复杂）。
        - U:一个 `m x m` 的**正交矩阵 (Orthogonal Matrix)**。它的列向量被称为“左奇异向量”，它们构成了一组标准正交基。
        - **`Σ` (Sigma)**: 一个 `m x n` 的**对角矩阵 (Diagonal Matrix)**。它非常“简单”，除了主对角线上的元素外，其他所有元素都为 0。主对角线上的这些非负数值被称为矩阵 `A` 的**奇异值 (Singular Values)**。这些值通常会从大到小排列。
        - **`V`**: 一个 `n x n` 的**正交矩阵**。它的列向量被称为“右奇异向量”，它们也构成了一组标准正交基。`Vᵀ` 代表 `V` 的转置。
    - 想要对一个矩阵 $\mathbf{A}$ 进行SVD分解，整体思路是：
        - 首先要找到 $\mathbf{A}\mathbf{A}^{T}$ 的特征值，获得矩阵 $\mathbf{\Sigma}$
        - 计算特征向量，获得矩阵 $\mathbf{V}^{T}$
        - 计算矩阵 $\mathbf{U}$，写出完整的SVD分解。
- 如果对一个模型仅沿X轴缩放，如何利用M矩阵计算光照？
    - 这里所说的计算光照，主要是指如何计算变换后的法线。
    - 沿X轴进行缩放，实际上是一个非均匀缩放的变换，我们可以构建出这个非均匀缩放的变换矩阵，计算其伴随矩阵的转置矩阵，使用这个矩阵来对顶点法线进行变换，最后对其进行归一化。然后即可使用这个法线来进行光照计算。
    - [[法线变换]]
- 绕世界坐标中某一物体自身的y轴旋转一定角度，相应的旋转矩阵怎么求？
    - 平移到世界中心
    - 绕自身 y 轴旋转矩阵
    - 平移回去
    - [[四元数]]
- MVP变换发生在GPU渲染管线的哪个阶段？
    - 几何处理阶段。输入信息的顶点数据（坐标和法线）
