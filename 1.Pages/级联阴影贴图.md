---
Type:
  - Page
aliases:
  - CSM
  - Cascade Shadow Map
tags: 
modifiedDate: 2025/06/25, 10:10:51
---

# Cascade Shadow Map

## 核心思路

-  级联阴影贴图, 其核心思路是沿着观察方向, 将视锥体划分为若干个区域, 一般是四个. 每个区域使用不同分辨率的阴影贴图, 越近的分辨率越高. 这样可以为距离观察者较近的, 也就是更为重要的表面, 提供更多的样本. 从而缓解瑕疵. 划分方法一般是均匀划分和对数划分[^1]

## 存在问题

### 在每个级联的边界存在阴影的突变

- 一种解决方法是让划分的深度区域稍微重叠，位于重叠区域的样本收集了相邻阴影贴图的结果，并对其进行混合；
- 另一种是使用抖动法（dithering）来在该区域内采集单个样本。

### 近裁剪平面的设置问题

近裁剪平面的设置会影响视锥体区域的划分范围，如果设置不恰当，那么最近的、最大分辨率的阴影贴图就会被浪费。
可以使用样本分布阴影贴图（sample distribution shadow maps，SDSM）的方法来确定划分方法，即根据前一帧中深度的最大最小值，以及考虑场景中物体的移动速度，来找到一个合适的近裁剪平面。

## 性能优化

- 只在光源和场景变化时重新计算阴影贴图
    - 如果光源和场景没有发生变化，则不需要重新计算该阴影贴图。对于每个光源而言，可以通过预先计算，找到光源视锥体内哪些物体是可见的，其中又有哪些物体会产生阴影，从而构建一个shadow caster的列表。
- 由于人眼很难精确判断生成的阴影是否是物理正确的，因此我们可以在级联阴影映射和其他算法中采取一切取巧的方法（trick）。例如使用低层级细节（LOD）的模型来作为实际投射阴影的代理模型；移除那些很小的遮挡物；较远处的阴影不需要每帧都进行更新，或者直接忽略动态物体的阴影，可以使用一个高分辨率的静态阴影贴图来代替这些位于较远位置的级联阴影贴图。
- 静态阴影贴图的大部分内容，在帧与帧之间都是相同的，可以重复使用，只有阴影的动态部分可能会发生变化，因此这部分需要重新渲染（Shadow Cache）。整个阴影贴图作为一个整体看待，而是将其划分为**静态部分**和**动态部分**，只更新变化的部分。
- 如果视锥体中的一个区域是相机看不见的，那么就不需要对该区域所接收到的阴影进行计算。因此可以使用相机的遮挡剔除，来找到所有可见的阴影接收物，然后从光源的角度，将所有的阴影接收物渲染到一个模板缓冲区中，来剔除那些没有不会接收阴影的物体。
    - **找到可见的接收物**：首先，通过常规的硬件遮挡查询（Occlusion Query）等技术，从**摄像机**的视角确定哪些物体是当前可见的。
    - **构建“可见区域”模板**：将这些“可见的接收物”从**光源**的视角进行渲染，但不是渲染到阴影贴图，而是渲染到一个**模板缓冲区（Stencil Buffer）**中。这样，模板缓冲区就形成了一个“面具”，标记出了阴影贴图中哪些像素是对应“可见表面”的。
    - **剔除不可见的阴影**：最后，正常地从光源视角渲染所有阴影投射物（Casters）来生成阴影贴图，但同时开启模板测试。GPU只会将深度信息写入那些通过了模板测试的像素（即那些会投射到可见表面上的阴影）。所有投射到不可见区域的阴影，其计算都被GPU在极早期阶段就直接抛弃了。

[^1]: 我的渲染器中实现为对数划分和均匀划分的加权 #渲染器实现细节  
